{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block extra_head %}
<style>
    .ingredient-selector {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }
    
    .ingredient-column {
        flex: 1;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        min-height: 300px;
        background-color: #f8f9fa;
    }
    
    .ingredient-column h6 {
        margin-top: 0;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 10px;
    }
    
    .ingredient-list {
        height: 250px;
        overflow-y: auto;
        margin-bottom: 10px;
    }
    
    .ingredient-item {
        padding: 5px;
        margin-bottom: 2px;
        background-color: white;
        border-radius: 3px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .ingredient-item:hover {
        background-color: #e9ecef;
    }
    
    .ingredient-item.selected {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
    }
    
    .ingredient-actions {
        display: flex;
        gap: 5px;
    }
    
    .ingredient-actions button {
        flex: 1;
    }
    
    .ingredient-search {
        margin-bottom: 10px;
    }
    
    .ingredient-search input {
        width: 100%;
        padding: 5px;
        border: 1px solid #ced4da;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">{{ title }}</h3>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="create-form">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}
                        
                        <div class="row">
                            {% for field in form %}
                            <div class="col-md-12 mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label">
                                    {{ field.label }}
                                    {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                
                                {% if field.name == 'ingredients' %}
                                    <div class="ingredient-selector">
                                        <div class="ingredient-column">
                                            <h6>üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</h6>
                                            <div class="ingredient-search">
                                                <input type="text" id="available-search" placeholder="–ü–æ–∏—Å–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤..." class="form-control form-control-sm">
                                            </div>
                                            <div class="ingredient-list" id="available-ingredients">
                                                {% for ingredient in available_ingredients %}
                                                <div class="ingredient-item" data-id="{{ ingredient.id }}" data-name="{{ ingredient.name|lower }}">
                                                    <input type="checkbox" name="ingredients" value="{{ ingredient.id }}" id="ingredient_{{ ingredient.id }}">
                                                    <label for="ingredient_{{ ingredient.id }}">{{ ingredient.name }}</label>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="ingredient-column">
                                            <h6>‚úÖ –í—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</h6>
                                            <div class="ingredient-search">
                                                <input type="text" id="selected-search" placeholder="–ü–æ–∏—Å–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤..." class="form-control form-control-sm">
                                            </div>
                                            <div class="ingredient-list" id="selected-ingredients">
                                                {% for ingredient in selected_ingredients %}
                                                <div class="ingredient-item selected" data-id="{{ ingredient.id }}" data-name="{{ ingredient.name|lower }}">
                                                    <input type="checkbox" name="ingredients" value="{{ ingredient.id }}" id="ingredient_{{ ingredient.id }}" checked>
                                                    <label for="ingredient_{{ ingredient.id }}">{{ ingredient.name }}</label>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ingredient-actions">
                                        <button type="button" class="btn btn-outline-primary btn-sm" id="move-to-selected">
                                            ‚û°Ô∏è –î–æ–±–∞–≤–∏—Ç—å ‚Üí
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="move-to-available">
                                            ‚Üê –£–±—Ä–∞—Ç—å
                                        </button>
                                    </div>
                                {% else %}
                                    {{ field }}
                                    {% if field.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in field.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                {% endif %}
                                
                                {% if field.help_text %}
                                <div class="form-text">{{ field.help_text }}</div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'table_'|add:model_name %}" class="btn btn-outline-secondary">
                                ‚Üê –ù–∞–∑–∞–¥ –∫ —Ç–∞–±–ª–∏—Ü–µ
                            </a>
                            <div class="btn-group">
                                {% if not is_create and object %}
                                <a href="{% url 'delete_'|add:model_name object.pk %}" class="btn btn-outline-danger">
                                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                </a>
                                {% endif %}
                                <button type="submit" class="btn btn-success" name="action" value="save">
                                    ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                </button>
                                {% if is_create %}
                                <button type="submit" class="btn btn-primary" name="action" value="save_and_add">
                                    ‚ûï –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    const availableList = document.getElementById('available-ingredients');
    const selectedList = document.getElementById('selected-ingredients');
    const moveToSelectedBtn = document.getElementById('move-to-selected');
    const moveToAvailableBtn = document.getElementById('move-to-available');
    const availableSearch = document.getElementById('available-search');
    const selectedSearch = document.getElementById('selected-search');
    
    // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
    moveToSelectedBtn.addEventListener('click', function() {
        const selectedCheckboxes = availableList.querySelectorAll('input[type="checkbox"]:checked');
        selectedCheckboxes.forEach(checkbox => {
            const item = checkbox.closest('.ingredient-item');
            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
            selectedList.appendChild(item);
            // –ú–µ–Ω—è–µ–º –∫–ª–∞—Å—Å—ã
            item.classList.add('selected');
            // –û—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–π
            checkbox.checked = true;
        });
    });
    
    // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≤ –¥–æ—Å—Ç—É–ø–Ω—ã–µ
    moveToAvailableBtn.addEventListener('click', function() {
        const selectedCheckboxes = selectedList.querySelectorAll('input[type="checkbox"]:checked');
        selectedCheckboxes.forEach(checkbox => {
            const item = checkbox.closest('.ingredient-item');
            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
            availableList.appendChild(item);
            // –ú–µ–Ω—è–µ–º –∫–ª–∞—Å—Å—ã
            item.classList.remove('selected');
            // –°–Ω–∏–º–∞–µ–º –≥–∞–ª–æ—á–∫—É
            checkbox.checked = false;
        });
    });
    
    // –ü–æ–∏—Å–∫ –ø–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º
    availableSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const items = availableList.querySelectorAll('.ingredient-item');
        
        items.forEach(item => {
            const name = item.getAttribute('data-name');
            if (name && name.includes(searchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    // –ü–æ–∏—Å–∫ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º
    selectedSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const items = selectedList.querySelectorAll('.ingredient-item');
        
        items.forEach(item => {
            const name = item.getAttribute('data-name');
            if (name && name.includes(searchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    document.getElementById('create-form').addEventListener('submit', function(e) {
        // –£–±–∏—Ä–∞–µ–º –≤—Å–µ unchecked —á–µ–∫–±–æ–∫—Å—ã –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
        const allIngredients = document.querySelectorAll('input[name="ingredients"]');
        allIngredients.forEach(checkbox => {
            if (!checkbox.checked) {
                checkbox.remove(); // –£–¥–∞–ª—è–µ–º unchecked —á–µ–∫–±–æ–∫—Å—ã –∏–∑ —Ñ–æ—Ä–º—ã
            }
        });
    });
});
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('create-form');
    const buttons = form.querySelectorAll('button[type="submit"]');
    
    buttons.forEach(button => {
        button.addEventListener('click', function() {
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å –∏–º–µ–Ω–µ–º –∫–Ω–æ–ø–∫–∏
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'action';
            hiddenInput.value = this.value;
            form.appendChild(hiddenInput);
        });
    });
});
</script>

{% endblock %}