{% extends 'base.html' %}
{% load core_extras %}

{% block title %}{{ table_title }}{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">üìä –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a></li>
            <li class="breadcrumb-item">
                {% if user.groups.first.name == '–î–∏—Ä–µ–∫—Ç–æ—Ä' %}
                <a href="{% url 'director_tables' %}">–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã</a>
                {% elif user.groups.first.name == '–ú–µ–Ω–µ–¥–∂–µ—Ä' %}
                <a href="{% url 'manager_tables' %}">–¢–∞–±–ª–∏—Ü—ã –º–µ–Ω–µ–¥–∂–µ—Ä–∞</a>
                {% elif user.groups.first.name == '–®–µ—Ñ-–ø–æ–≤–∞—Ä' %}
                <a href="{% url 'chef_tables' %}">–¢–∞–±–ª–∏—Ü—ã —à–µ—Ñ-–ø–æ–≤–∞—Ä–∞</a>
                {% elif user.groups.first.name == '–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –∫–∞–¥—Ä–∞–º' %}
                <a href="{% url 'hr_tables' %}">–¢–∞–±–ª–∏—Ü—ã HR</a>
                {% endif %}
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ table_title }}</li>
        </ol>
    </nav>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫–∏ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1">{{ table_title }}</h1>
            <p class="text-muted mb-0">
                –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: <strong>{{ page_obj.paginator.count }}</strong>
                {% if page_obj.paginator.num_pages > 1 %}
                | –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}
                {% endif %}
            </p>
        </div>
        <div class="btn-group">
            {% if has_add_permission %}
            <a href="{% url 'add_'|add:model_name %}" class="btn btn-success">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
            </a>
            {% endif %}
            <a href="
                {% if user.groups.first.name == '–î–∏—Ä–µ–∫—Ç–æ—Ä' %}{% url 'director_tables' %}
                {% elif user.groups.first.name == '–ú–µ–Ω–µ–¥–∂–µ—Ä' %}{% url 'manager_tables' %}
                {% elif user.groups.first.name == '–®–µ—Ñ-–ø–æ–≤–∞—Ä' %}{% url 'chef_tables' %}
                {% elif user.groups.first.name == '–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –∫–∞–¥—Ä–∞–º' %}{% url 'hr_tables' %}
                {% else %}{% url 'dashboard' %}{% endif %}" 
                class="btn btn-outline-secondary">
                ‚Üê –ù–∞–∑–∞–¥ –∫ —Ç–∞–±–ª–∏—Ü–∞–º
            </a>
        </div>
    </div>

    <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="text" name="search" class="form-control" 
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–º –ø–æ–ª—è–º..." 
                               value="{{ request.GET.search|default:'' }}">
                        <button type="submit" class="btn btn-primary">
                            üîç –ü–æ–∏—Å–∫
                        </button>
                        {% if request.GET.search %}
                        <a href="?" class="btn btn-outline-secondary">–û—á–∏—Å—Ç–∏—Ç—å</a>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <select name="per_page" class="form-select" onchange="this.form.submit()">
                            <option value="10" {% if not request.GET.per_page or request.GET.per_page == '10' %}selected{% endif %}>10 –∑–∞–ø–∏—Å–µ–π</option>
                            <option value="20" {% if request.GET.per_page == '20' %}selected{% endif %}>20 –∑–∞–ø–∏—Å–µ–π</option>
                            <option value="50" {% if request.GET.per_page == '50' %}selected{% endif %}>50 –∑–∞–ø–∏—Å–µ–π</option>
                            <option value="100" {% if request.GET.per_page == '100' %}selected{% endif %}>100 –∑–∞–ø–∏—Å–µ–π</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="50">#</th>
                            {% for field in fields %}
                            <th>
                                <a href="#" onclick="sortBy('{{ field.name }}')" class="text-decoration-none">
                                    {{ field.verbose_name|default:field.name|title }}
                                    {% if current_order_by == field.name %}
                                        {% if current_direction == 'asc' %} ‚Üë {% else %} ‚Üì {% endif %}
                                    {% endif %}
                                </a>
                                <small class="text-muted d-block" style="font-size: 0.7em; font-weight: normal;">
                                    {% if field.type == 'foreign_key' %}‚ÜîÔ∏è –°–≤—è–∑—å
                                    {% elif field.type == 'datetime' %}üïê –î–∞—Ç–∞/–≤—Ä–µ–º—è
                                    {% elif field.type == 'date' %}üìÖ –î–∞—Ç–∞
                                    {% elif field.type == 'boolean' %}‚úÖ –î–∞/–ù–µ—Ç
                                    {% elif field.type == 'image' %}üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                                    {% elif field.type == 'decimal' %}üí∞ –ß–∏—Å–ª–æ
                                    {% elif field.type == 'choice' %}üìã –í—ã–±–æ—Ä
                                    {% else %}üìù –¢–µ–∫—Å—Ç{% endif %}
                                </small>
                            </th>
                            {% endfor %}
                            {% if has_change_permission or has_delete_permission %}
                            <th width="120" class="text-end">–î–µ–π—Å—Ç–≤–∏—è</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for object in object_list %}
                        <tr>
                            <td class="text-muted">{{ forloop.counter0|add:page_obj.start_index }}</td>
                            {% for field in fields %}
                            <td>
                                {% with value=object|get_attribute:field.name %}
                                    {% if field.type == 'foreign_key' and value %}
                                        <span class="badge bg-primary" title="–°–≤—è–∑–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç">
                                            {{ value|truncatechars:30 }}
                                        </span>
                                    {% elif field.type == 'datetime' and value %}
                                        {{ value|date:"d.m.Y H:i" }}
                                    {% elif field.type == 'date' and value %}
                                        {{ value|date:"d.m.Y" }}
                                    {% elif field.type == 'boolean' %}
                                        {% if value %}‚úÖ –î–∞{% else %}‚ùå –ù–µ—Ç{% endif %}
                                    {% elif field.type == 'image' and value %}
                                        <img src="{{ value.url }}" alt="" style="max-height: 40px;" class="img-thumbnail">
                                    {% elif field.type == 'decimal' and value is not None %}
                                        {% if field.name == 'price' or field.name == 'purchase_price' %}
                                            {{ value }} ‚ÇΩ
                                        {% elif field.name == 'price_premium' %}
                                            {{ value }}%
                                        {% else %}
                                            {{ value }}
                                        {% endif %}
                                    {% elif field.type == 'choice' and value %}
                                        {% with display_method=field.name|add:'_display' %}
                                            {% if object|get_attribute:display_method %}
                                                {{ object|get_attribute:display_method }}
                                            {% else %}
                                                {{ value }}
                                            {% endif %}
                                        {% endwith %}
                                    {% elif value %}
                                        {{ value|truncatechars:50 }}
                                    {% else %}
                                        <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                {% endwith %}
                            </td>
                            {% endfor %}
                            {% if has_change_permission or has_delete_permission %}
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        {% if has_change_permission %}
                                        <a href="{% url 'edit_'|add:model_name object.id %}" 
                                        class="btn btn-outline-warning" title="–ò–∑–º–µ–Ω–∏—Ç—å">
                                            ‚úèÔ∏è
                                        </a>
                                        {% endif %}
                                        {% if has_delete_permission %}
                                        <a href="{% url 'delete_'|add:model_name object.id %}" 
                                        class="btn btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å">
                                            üóëÔ∏è
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                                {% endif %}
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="{{ fields|length|add:2 }}" class="text-center py-5">
                                <div class="text-muted">
                                    <div class="display-4 mb-3">üì≠</div>
                                    <h5>–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞</h5>
                                    <p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                                    {% if has_add_permission %}
                                    <a href="{% url 'add_'|add:model_name %}" class="btn btn-primary mt-2">
                                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        {% if page_obj.paginator.num_pages > 1 %}
        <div class="card-footer">
            <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">
                <ul class="pagination justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}">
                            ¬´ –ü–µ—Ä–≤–∞—è
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}">
                            ‚Üê –ù–∞–∑–∞–¥
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}">
                                {{ num }}
                            </a>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}">
                            –í–ø–µ—Ä–µ–¥ ‚Üí
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}">
                            –ü–æ—Å–ª–µ–¥–Ω—è—è ¬ª
                        </a>
                    </li>
                    {% endif %}
                </ul>
                <p class="text-center text-muted small mt-2 mb-0">
                    –ü–æ–∫–∞–∑–∞–Ω–æ {{ page_obj.start_index }}‚Äì{{ page_obj.end_index }} –∏–∑ {{ page_obj.paginator.count }} –∑–∞–ø–∏—Å–µ–π
                </p>
            </nav>
        </div>
        {% endif %}
    </div>

    <div class="card mt-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞–±–ª–∏—Ü–µ</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã:</h6>
                    <ul class="list-unstyled mb-0">
                        <li><strong>–í—Å–µ–≥–æ –ø–æ–ª–µ–π:</strong> {{ fields|length }}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>üîë –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:</h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="display-6 {% if has_add_permission %}text-success{% else %}text-muted{% endif %}">
                                {% if has_add_permission %}‚ûï{% else %}‚ùå{% endif %}
                            </div>
                            <small>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ</small>
                        </div>
                        <div class="col-4">
                            <div class="display-6 {% if has_change_permission %}text-success{% else %}text-muted{% endif %}">
                                {% if has_change_permission %}‚úèÔ∏è{% else %}‚ùå{% endif %}
                            </div>
                            <small>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</small>
                        </div>
                        <div class="col-4">
                            <div class="display-6 {% if has_delete_permission %}text-success{% else %}text-muted{% endif %}">
                                {% if has_delete_permission %}üóëÔ∏è{% else %}‚ùå{% endif %}
                            </div>
                            <small>–£–¥–∞–ª–µ–Ω–∏–µ</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if m2m_fields %}
    <div class="alert alert-info mt-4">
        <h6>üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (ManyToMany):</h6>
        <div class="row">
            {% for field in m2m_fields %}
            <div class="col-md-4 mb-2">
                <span class="badge bg-info">{{ field.verbose_name }}</span>
                <small class="text-muted">(—Å–≤—è–∑—å –º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º)</small>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
function sortBy(fieldName) {
    const currentOrderBy = "{{ current_order_by }}";
    const currentDirection = "{{ current_direction }}";
    let newDirection = "asc";
    
    // –ï—Å–ª–∏ —É–∂–µ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —ç—Ç–æ–º—É –ø–æ–ª—é, –º–µ–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    if (currentOrderBy === fieldName) {
        newDirection = currentDirection === "asc" ? "desc" : "asc";
    }
    
    // –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    let params = new URLSearchParams(window.location.search);
    params.set('order_by', fieldName);
    params.set('direction', newDirection);
    
    // –ï—Å–ª–∏ –±—ã–ª –ø–æ–∏—Å–∫, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ
    if ("{{ search_query }}") {
        params.set('search', "{{ search_query|escapejs }}");
    }
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ –Ω–æ–≤–æ–º—É URL
    window.location.search = params.toString();
}
</script>

{% endblock %}